import os
import threading
from tkinter import Tk, StringVar, filedialog, messagebox, Listbox, END, ttk
from PIL import Image, ImageTk
from pydub import AudioSegment
from tkinterdnd2 import DND_FILES, TkinterDnD

# ----------------------------
# File and Folder Selection
# ----------------------------
def update_selected_files():
    selected_files.set("\n".join(selected_files_list))
    status_var.set(f"{len(selected_files_list)} file(s) selected.")

def add_files():
    files = filedialog.askopenfilenames(
        parent=root,
        title="Select Audio Files",
        filetypes=[("Audio Files", "*.mp3 *.wav *.flac *.ogg *.aac"), ("All Files", "*.*")]
    )
    for f in files:
        if f not in selected_files_list:
            selected_files_list.append(f)
    update_selected_files()

def remove_selected_files():
    if not selected_files_list:
        return
    # Popup window to remove files
    popup = Tk()
    popup.title("Remove Files")
    popup.geometry("400x300")
    popup.configure(bg="#2b2b2b")

    ttk.Label(popup, text="Select file(s) to remove:", background="#2b2b2b", foreground="white").pack(pady=5)

    listbox = Listbox(popup, selectmode="extended", bg="#2b2b2b", fg="white")
    listbox.pack(expand=True, fill="both", padx=10, pady=5)
    for f in selected_files_list:
        listbox.insert(END, f)

    def remove_and_close():
        selected_indices = list(listbox.curselection())
        selected_indices.reverse()
        for i in selected_indices:
            selected_files_list.pop(i)
        update_selected_files()
        popup.destroy()

    ttk.Button(popup, text="Remove Selected", command=remove_and_close, style="Accent.TButton").pack(pady=10)
    popup.mainloop()

def clear_all_files():
    selected_files_list.clear()
    update_selected_files()

def drop(event):
    files = root.tk.splitlist(event.data)
    for f in files:
        if os.path.isfile(f) and f not in selected_files_list:
            selected_files_list.append(f)
    update_selected_files()

def select_output_folder():
    folder = filedialog.askdirectory(title="Select Output Folder")
    if folder:
        output_folder.set(folder)
        status_var.set("Output folder selected.")

# ----------------------------
# Conversion Logic
# ----------------------------
def convert_thread():
    try:
        files = selected_files_list
        if not files:
            messagebox.showerror("Error", "Please select audio file(s).")
            return

        folder = output_folder.get()
        if not os.path.isdir(folder):
            messagebox.showerror("Error", "Please select a valid output folder.")
            return

        fmt = format_var.get().lower()
        progress["value"] = 0
        progress["maximum"] = len(files)
        status_var.set("Converting...")

        skipped_files = []

        for i, file in enumerate(files):
            try:
                audio = AudioSegment.from_file(file)
            except:
                skipped_files.append(os.path.basename(file))
                continue

            base_name = os.path.splitext(os.path.basename(file))[0]
            output_file = os.path.join(folder, f"{base_name}.{fmt}")

            counter = 1
            while os.path.exists(output_file):
                output_file = os.path.join(folder, f"{base_name}({counter}).{fmt}")
                counter += 1

            audio.export(output_file, format=fmt)
            progress["value"] = i + 1
            status_var.set(f"Saved as: {os.path.basename(output_file)}")
            root.update_idletasks()

        status_var.set("Conversion Completed")
        msg = f"{len(files) - len(skipped_files)} file(s) converted successfully."
        if skipped_files:
            msg += f"\nSkipped (invalid) files:\n" + "\n".join(skipped_files)
        messagebox.showinfo("Success", msg)

    except Exception as e:
        status_var.set("Error occurred")
        messagebox.showerror("Conversion Error", str(e))
    finally:
        convert_btn.config(state="normal")

def convert_files():
    if not selected_files_list:
        messagebox.showerror("Error", "Please select audio file(s) to convert.")
        return
    if not output_folder.get():
        messagebox.showerror("Error", "Please select an output folder.")
        return
    convert_btn.config(state="disabled")
    threading.Thread(target=convert_thread, daemon=True).start()

# ----------------------------
# GUI Setup (original UI preserved)
# ----------------------------
root = TkinterDnD.Tk()
root.title("AudioForge â€“ forge your audio files into any format.")
root.geometry("700x720")
root.configure(bg="#1e1e1e")
root.resizable(False, False)

style = ttk.Style()
style.theme_use("clam")
style.configure("TFrame", background="#2b2b2b")
style.configure("TLabel", background="#2b2b2b", foreground="white", font=("Segoe UI", 10))
style.configure("Header.TLabel", background="#1e1e1e", foreground="white",
                font=("Segoe UI", 22, "bold"))
style.configure("Accent.TButton", background="#3e8ef7", foreground="white",
                font=("Segoe UI", 11, "bold"), padding=6)
style.map("Accent.TButton", background=[("active", "#62a5ff")])
style.configure("Success.TButton",
                font=("Segoe UI", 11, "bold"),
                padding=6,
                foreground="white")
style.map("Success.TButton",
          foreground=[("active", "white"), ("disabled", "gray"), ("!active", "white")],
          background=[("active", "#4bcc63"), ("!active", "#28a745")])
style.configure("TProgressbar", troughcolor="#3a3a3a",
                background="#4fd1c5", bordercolor="#3a3a3a")
style.configure("Status.TLabel", background="#111",
                foreground="white", padding=10, font=("Segoe UI", 10))

selected_files = StringVar()
output_folder = StringVar()
format_var = StringVar(value="mp3")
status_var = StringVar(value="Ready")
selected_files_list = []

# Logo
try:
    logo_image = Image.open("team_logo.jpeg")
    logo_image = logo_image.resize((60, 60))
    logo_photo = ImageTk.PhotoImage(logo_image)
    ttk.Label(root, text="Powered by 0XBugz",
              foreground="white", background="#1e1e1e",
              font=("Segoe UI",)).pack(pady=(10, 0))
    logo_label = ttk.Label(root, image=logo_photo, background="#1e1e1e")
    logo_label.image = logo_photo
    logo_label.pack(pady=(15, 5))
except:
    pass

ttk.Label(root, text="Audio Converter", style="Header.TLabel").pack(pady=10)

# File Selection Frame
file_frame = ttk.Frame(root, padding=15, style="TFrame")
file_frame.pack(padx=30, pady=10, fill="x")
ttk.Label(file_frame, text="Selected File(s):").pack(anchor="w")

selected_files_label = ttk.Label(file_frame, textvariable=selected_files, foreground="#4aa3f0",
                                 wraplength=650, justify="left", background="#2b2b2b")
selected_files_label.pack(anchor="w", pady=3)
selected_files_label.drop_target_register(DND_FILES)
selected_files_label.dnd_bind('<<Drop>>', drop)

ttk.Button(file_frame, text="Browse Files", command=add_files,
           style="Accent.TButton", width=18).pack(pady=5)
ttk.Button(file_frame, text="Remove Selected", command=remove_selected_files,
           style="Accent.TButton", width=18).pack(pady=2)
ttk.Button(file_frame, text="Clear All", command=clear_all_files,
           style="Accent.TButton", width=18).pack(pady=2)

# Output Folder Frame
folder_frame = ttk.Frame(root, padding=15, style="TFrame")
folder_frame.pack(padx=30, pady=10, fill="x")
ttk.Label(folder_frame, text="Output Folder:").pack(anchor="w")
ttk.Label(folder_frame, textvariable=output_folder, foreground="#4aa3f0",
          wraplength=650, background="#2b2b2b").pack(anchor="w", pady=3)
ttk.Button(folder_frame, text="Select Folder", command=select_output_folder,
           style="Accent.TButton", width=18).pack(pady=5)

# Format Selection
format_frame = ttk.Frame(root, style="TFrame")
format_frame.pack(pady=10, padx=30, fill="x")
ttk.Label(format_frame, text="Output Format: ").pack(side="left", padx=(0, 10))
format_combo = ttk.Combobox(format_frame, textvariable=format_var,
                            values=["mp3", "wav", "flac", "ogg", "aac"],
                            state="readonly", width=10)
format_combo.pack(side="left")

# Progress Bar
progress = ttk.Progressbar(root, length=500)
progress.pack(pady=10)

# Convert Button
convert_btn = ttk.Button(root, text="Convert Audio", command=convert_files,
                         style="Success.TButton", width=22)
convert_btn.pack(pady=(10,20))

# Status Bar
status_label = ttk.Label(root, textvariable=status_var,
                         style="Status.TLabel", anchor="w")
status_label.pack(fill="x", side="bottom")

root.mainloop()
